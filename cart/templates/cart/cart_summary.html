{% extends "base.html" %}
{% load static %}
{% load custom_filters %}


{% block content %}

{% include 'includes/shopping_cart_offcanvas.html' %}


<!-- Page content -->
<div class="overlay"></div>
<main class="content-wrapper-shop">
    <div class="container pb-5 mb-2 mb-sm-3 mb-lg-4 mb-xl-5">

        <!-- Breadcrumb -->
        <nav class="position-relative pt-3 my-3 my-md-4" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a class="link-dark" href="{% url 'home' %}">Home</a></li>
                <li class="breadcrumb-item"><a class="link-dark" href="{% url 'catalog' %}">Products</a></li>
                <li class="breadcrumb-item active d-none d-sm-block" aria-current="page">Cart</li>
            </ol>
        </nav>

        <section class="container pb-5 mb-2 mb-md-3 mb-lg-4 mb-xl-5">
            <h1 class="h3 mb-4">Shopping cart</h1>
            <div class="row">

                <!-- Items list -->
                <div class="col-lg-8">
                    <div class="pe-lg-2 pe-xl-3 me-xl-3">

                        <!-- Table of items -->
                        <table class="table position-relative z-2 mb-4">
                            <thead>
                                <tr>
                                    <th scope="col" class="fs-sm fw-normal py-3 ps-0"><span
                                            class="text-body">Product</span></th>
                                    <th scope="col" class="text-body fs-sm fw-normal py-3 d-none d-xl-table-cell"><span
                                            class="text-body">Price</span></th>
                                    <th scope="col" class="text-body fs-sm fw-normal py-3 d-none d-md-table-cell"><span
                                            class="text-body">Quantity</span></th>
                                    <th scope="col" class="text-body fs-sm fw-normal py-3 d-none d-md-table-cell"><span
                                            class="text-body">Total</span></th>
                                    <th scope="col" class="py-0 px-0">
                                        <div class="nav justify-content-start">
                                            <button type="button"
                                                class="nav-link d-inline-block text-decoration-underline text-nowrap py-3 px-0 fs-6">
                                                <span class="d-none d-sm-inline">Clear cart</span>
                                                <span class="d-sm-none fs-xl"><i
                                                        class="fa-sharp-duotone fa-solid fa-cart-circle-xmark"></i></span>
                                            </button>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="align-middle">

                                <!-- Item -->
                                {% for product in cart_products %}
                                <tr>
                                    <td class="py-3 ps-0">
                                        <div class="d-flex align-items-center">
                                            {% if product.image %}
                                            <a href="{% url 'product_detail' product.id %}" class="flex-shrink-0">
                                                <img class="card-img-top img-fluid "
                                                    style="aspect-ratio: 1 / 1; object-fit: cover; object-position: top; width: 100px;"
                                                    src="{{ product.image.url }}" alt="{{ product.name }}">
                                            </a>
                                            {% else %}
                                            <a href="{% url 'product_detail' product.id %}" class="flex-shrink-0">
                                                <img class="card-img-top img-fluid"
                                                    style="aspect-ratio: 1 / 1; object-fit: cover; object-position: top; width: 110px;"
                                                    src="{{ MEDIA_URL }}noimage.png" alt="{{ product.name }}">
                                            </a>
                                            {% endif %}
                                            <div class="w-100 min-w-0 ps-2 ps-xl-3 count-input-cart truncate">
                                                <h5 class="d-flex mb-2">
                                                    <a class="d-block fs-sm fw-medium"
                                                        href="{% url 'product_detail' product.id %}">{{ product.name }}</a>
                                                </h5>
                                                <ul class="list-unstyled gap-1 fs-xs mb-0">
                                                    <li><span class="text-body-secondary">Brand:</span> <span
                                                            class="text-dark-emphasis fw-medium">{{ product.brand.friendly_name }}</span>
                                                    </li>
                                                    <li><span class="text-body-secondary">Material:</span> <span
                                                            class="text-dark-emphasis fw-medium">{{ product.material }}</span>
                                                    </li>
                                                    <li class="d-xl-none"><span
                                                            class="text-body-secondary">Price:</span> <span
                                                            class="text-dark-emphasis fw-medium">£{{ product.price }}</span>
                                                    </li>
                                                </ul>
                                                <div class="count-input rounded-2 d-md-none mt-3">
                                                    <button type="button" class="btn btn-sm btn-icon" data-decrement
                                                        aria-label="Decrement quantity">
                                                        <i class="fa-regular fa-minus"></i>
                                                    </button>
                                                    {% for key, value in items_quantities.items %}
                                                    {% if key == product.id|slugify %}
                                                    {% with quantity=value %}
                                                    <input type="number" class="form-control form-control-sm"
                                                        value="{{ quantity }}" readonly>
                                                    {% endwith %}
                                                    {% endif %}
                                                    {% endfor %}
                                                    <button type="button" class="btn btn-sm btn-icon" data-increment
                                                        aria-label="Increment quantity">
                                                        <i class="fa-regular fa-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="h6 py-3 d-none d-xl-table-cell">£{{ product.price }}</td>
                                    <td class="py-3 d-none d-md-table-cell count-input-cart">
                                        <div class="count-input">
                                            <button id="cart-item-decrement" type="button" class="btn btn-icon"
                                                aria-label="Decrement quantity">
                                                <i class="fa-regular fa-minus"></i>
                                            </button>
                                            {% for key, value in items_quantities.items %}
                                            {% if key == product.id|slugify %}
                                            {% with quantity=value %}
                                            <input type="number" class="form-control" value="{{ quantity }}" readonly>
                                            {% endwith %}
                                            {% endif %}
                                            {% endfor %}
                                            <button id="cart-item-increment" type="button" class="btn btn-icon"
                                                aria-label="Increment quantity">
                                                <i class="fa-regular fa-plus"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td class="h6 py-3 d-none d-md-table-cell">
                                        £
                                        {% for key, value in cart_subtotals.items %}
                                        {% if key == product.id|slugify %}
                                        {{ value }}
                                        {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td class="text-end py-3 px-0">
                                        <button type="button" class="btn-close fs-sm" data-bs-toggle="tooltip"
                                            data-bs-custom-class="tooltip-sm" data-bs-title="Remove"
                                            aria-label="Remove from cart"></button>
                                    </td>
                                </tr>
                                {% endfor %}

                            </tbody>
                        </table>

                        <div class="nav position-relative z-2 mb-4 mb-lg-0">
                            <a class="nav-link animate-underline px-0" href="{% url 'catalog' %}">
                                <i class="fa-duotone fa-solid fa-chevrons-left fs-lg me-1"></i>
                                <span class="fs-sm">Continue shopping</span>
                            </a>
                        </div>
                    </div>
                </div>


                <!-- Order summary (sticky sidebar) -->
                <aside class="col-lg-4" style="margin-top: -100px">
                    <div class="position-sticky top-0" style="padding-top: 100px">
                        <div class="bg-body-tertiary rounded-5 p-4 mb-3">
                            <div class="p-sm-2 p-lg-0 p-xl-2">
                                <h5 class="border-bottom pb-4 mb-4">Order summary</h5>
                                <ul class="list-unstyled fs-sm gap-3 mb-0">
                                    <li class="d-flex justify-content-between">
                                        Subtotal (3 items):
                                        <span class="text-dark-emphasis fw-medium">£{{ cart_totals }}</span>
                                    </li>
                                    <li class="d-flex justify-content-between">
                                        Saving:
                                        <span class="text-danger fw-medium">-£{{ saving }}</span>
                                    </li>
                                    <li class="d-flex justify-content-between">
                                        Shipping:
                                        <span class="text-dark-emphasis fw-medium">£{{ ship_cost }}</span>
                                    </li>
                                </ul>
                                <div class="border-top pt-4 mt-4">
                                    <div class="d-flex justify-content-between mb-3">
                                        <span class="fs-sm">Estimated total:</span>
                                        <span class="h5 mb-0">£{{ grand_total }}</span>
                                    </div>
                                    <a class="btn btn-lg btn-primary rounded-pill w-100 mt-4"
                                        href="checkout-v1-delivery-1.html">
                                        Proceed to checkout
                                        <i class="ci-chevron-right fs-lg ms-1 me-n1"></i>
                                    </a>
                                    <div class="nav justify-content-center fs-sm mt-3">
                                        <a class="nav-link text-decoration-underline p-0 me-1" href=""
                                            data-bs-toggle="offcanvas" role="button">Create an account</a>
                                        and get
                                        <span class="text-dark-emphasis fw-medium ms-1">your bonuses</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion bg-body-tertiary rounded-5 p-4">
                            <div class="accordion-item border-0">
                                <h3 class="accordion-header" id="promoCodeHeading">
                                    <button type="button"
                                        class="accordion-button animate-underline collapsed py-0 ps-sm-2 ps-lg-0 ps-xl-2"
                                        data-bs-toggle="collapse" data-bs-target="#promoCode" aria-expanded="false"
                                        aria-controls="promoCode">
                                        <i class="ci-percent fs-xl me-2"></i>
                                        <span class="animate-target me-2">Apply promo code</span>
                                    </button>
                                </h3>
                                <div class="accordion-collapse collapse" id="promoCode"
                                    aria-labelledby="promoCodeHeading">
                                    <div class="accordion-body pt-3 pb-2 ps-sm-2 px-lg-0 px-xl-2">
                                        <form class="needs-validation d-flex gap-2" novalidate>
                                            <div class="position-relative w-100">
                                                <input id="cart-display_quantity" type="text" class="form-control" placeholder="Enter promo code"
                                                    required>
                                                <div class="invalid-tooltip bg-transparent py-0">Enter a valid promo
                                                    code!</div>
                                            </div>
                                            <button type="submit" class="btn btn-dark">Apply</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </section>

</main>


{% endblock %}

{% block postloadjs %}
{{ block.super }}
<!-- Page specific scripts -->
<script>
    $(document).ready(function () {
        // Listen for clicks on the decrease button
        $('#decrease_qtty').on('click', function () {
            let quantityInput = $('#display_qtty');
            let currentQuantity = parseInt(quantityInput.val());
            if (currentQuantity > 1) {
                quantityInput.val(currentQuantity - 1);
            }
        });

        // Listen for clicks on the increase button
        $('#increase_qtty').on('click', function () {
            let quantityInput = $('#display_qtty');
            let currentQuantity = parseInt(quantityInput.val());
            if (currentQuantity < 29) {
                quantityInput.val(currentQuantity + 1);
            }
        });

        // Listen for clicks on the 'Add to Cart' button
        $('#add_to_cart_submit').on('click', function () {
            let productId = $(this).val();

            let quantity = $('#display_qtty').val();

            $.ajax({
                type: 'POST',
                url: '/cart/add/',
                data: {
                    'product_id': productId,
                    'quantity': quantity,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (json) {
                    window.location.reload();
                },
                error: function (xhr, errmsg, err) {
                    alert('Failed to add product to cart.');
                }
            });
        });
    });
</script>

{% endblock %}